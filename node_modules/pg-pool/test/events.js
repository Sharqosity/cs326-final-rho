<<<<<<< HEAD
var expect = require('expect.js')
var EventEmitter = require('events').EventEmitter
var describe = require('mocha').describe
var it = require('mocha').it
var objectAssign = require('object-assign')
var Pool = require('../')

describe('events', function () {
  it('emits connect before callback', function (done) {
    var pool = new Pool()
    var emittedClient = false
=======
'use strict'

const expect = require('expect.js')
const EventEmitter = require('events').EventEmitter
const describe = require('mocha').describe
const it = require('mocha').it
const Pool = require('../')

describe('events', function () {
  it('emits connect before callback', function (done) {
    const pool = new Pool()
    let emittedClient = false
>>>>>>> 104b65a6409f9d6ba105288e6952992f9f09ce79
    pool.on('connect', function (client) {
      emittedClient = client
    })

    pool.connect(function (err, client, release) {
      if (err) return done(err)
      release()
      pool.end()
      expect(client).to.be(emittedClient)
      done()
    })
  })

<<<<<<< HEAD
  it('emits "connect" only with a successful connection', function (done) {
    var pool = new Pool({
      // This client will always fail to connect
      Client: mockClient({
        connect: function (cb) {
          process.nextTick(function () { cb(new Error('bad news')) })
        }
      })
=======
  it('emits "connect" only with a successful connection', function () {
    const pool = new Pool({
      // This client will always fail to connect
      Client: mockClient({
        connect: function (cb) {
          process.nextTick(() => {
            cb(new Error('bad news'))
          })
        },
      }),
>>>>>>> 104b65a6409f9d6ba105288e6952992f9f09ce79
    })
    pool.on('connect', function () {
      throw new Error('should never get here')
    })
<<<<<<< HEAD
    pool._create(function (err) {
      if (err) done()
      else done(new Error('expected failure'))
    })
  })

  it('emits acquire every time a client is acquired', function (done) {
    var pool = new Pool()
    var acquireCount = 0
=======
    return pool.connect().catch((e) => expect(e.message).to.equal('bad news'))
  })

  it('emits acquire every time a client is acquired', function (done) {
    const pool = new Pool()
    let acquireCount = 0
>>>>>>> 104b65a6409f9d6ba105288e6952992f9f09ce79
    pool.on('acquire', function (client) {
      expect(client).to.be.ok()
      acquireCount++
    })
<<<<<<< HEAD
    for (var i = 0; i < 10; i++) {
      pool.connect(function (err, client, release) {
        err ? done(err) : release()
        release()
        if (err) return done(err)
=======
    for (let i = 0; i < 10; i++) {
      pool.connect(function (err, client, release) {
        if (err) return done(err)
        release()
>>>>>>> 104b65a6409f9d6ba105288e6952992f9f09ce79
      })
      pool.query('SELECT now()')
    }
    setTimeout(function () {
      expect(acquireCount).to.be(20)
      pool.end(done)
<<<<<<< HEAD
    }, 40)
  })

  it('emits error and client if an idle client in the pool hits an error', function (done) {
    var pool = new Pool()
    pool.connect(function (err, client) {
      expect(err).to.equal(null)
=======
    }, 100)
  })

  it('emits error and client if an idle client in the pool hits an error', function (done) {
    const pool = new Pool()
    pool.connect(function (err, client) {
      expect(err).to.equal(undefined)
>>>>>>> 104b65a6409f9d6ba105288e6952992f9f09ce79
      client.release()
      setImmediate(function () {
        client.emit('error', new Error('problem'))
      })
      pool.once('error', function (err, errClient) {
        expect(err.message).to.equal('problem')
        expect(errClient).to.equal(client)
        done()
      })
    })
  })
})

<<<<<<< HEAD
function mockClient (methods) {
  return function () {
    var client = new EventEmitter()
    objectAssign(client, methods)
=======
function mockClient(methods) {
  return function () {
    const client = new EventEmitter()
    Object.assign(client, methods)
>>>>>>> 104b65a6409f9d6ba105288e6952992f9f09ce79
    return client
  }
}
